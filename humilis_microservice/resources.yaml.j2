---
{% set globs={} %}
{% if dynamodb_capacity.read|int or dynamodb_capacity.write|int %}
{% set _ = globs.update({'stateful': True}) %}
{% else %}
{% set _ = globs.update({'stateful': False}) %}
{% endif %}
resources:
    {% if not api_id %}
    RestApi:
      Type: "AWS::ApiGateway::RestApi"
      Properties:
        Name: "{{_env.name}}-{{_layer.name}}"
    {% endif %}

    Lambda:
      Type: "AWS::Lambda::Function"
      Properties:
        Code:
          S3Bucket: "{{lambda_function.s3bucket}}"
          S3Key: "{{lambda_function.s3key}}"
        Runtime: "python2.7"
        MemorySize: "{{memory_size}}"
        Description: "{{_layer.description}}"
        {# in seconds #}
        Timeout: "{{timeout}}"
        Handler: "handler.lambda_handler"
        Role:
          "Fn::GetAtt":
              - LambdaExecutionRole
              - Arn
        Environment:
          Variables:
              "HUMILIS_ENVIRONMENT": "{{_env.name}}"
              "HUMILIS_STAGE": "{{_env.stage}}"
              "HUMILIS_LAYER": "{{_layer.name}}"
              {% if environment %}
              {% for varname, varvalue in environment.items() %}
              "{{varname}}": "{{varvalue}}"
              {% endfor %}
              {% endif %}

    {% if globs.stateful %}
    StateTable:
      Type: "AWS::DynamoDB::Table"
      Properties:
        AttributeDefinitions:
        {# The state item id #}
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: {{dynamodb_capacity.read}}
          WriteCapacityUnits: {{dynamodb_capacity.write}}
        {% if _env.stage %}
        TableName: {{_env.name}}-{{_layer.name}}-{{_env.stage}}-state
        {% else %}
        TableName: {{_env.name}}-{{_layer.name}}-state
        {% endif %}
    {% endif %}

    LambdaPermission:
      Type: "AWS::Lambda::Permission"
      Properties:
        Action: "lambda:invokeFunction"
        FunctionName: {"Fn::GetAtt": ["Lambda", "Arn"]}
        Principal: "apigateway.amazonaws.com"
        SourceArn:
            "Fn::Join":
                - ""
                -
                  - "arn:aws:execute-api:"
                  - {"Ref": "AWS::Region"}
                  - ":"
                  - {"Ref": "AWS::AccountId"}
                  - ":"
                  {% if api_id %}
                  - "{{api_id}}"
                  {% else %}
                  - {"Ref": "RestApi"}
                  {% endif %}
                  - "/*"

    LambdaExecutionRole:
      Type: "AWS::IAM::Role"
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                  Service: 'lambda.amazonaws.com'
              Action: 'sts:AssumeRole'
        # Keep all environment role under the same path
        Path: {{ "/{}/".format(_env.name) }}
        Policies:
          - PolicyName: root
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  # Write access to Cloudwatch logs
                  Action:
                    - "logs:CreateLogGroup"
                    - "logs:CreateLogStream"
                    - "logs:PutLogEvents"
                  Resource: "arn:aws:logs:*:*:*"
                  {% if globs.stateful %}
                - Effect: Allow
                  # Read/write permission on the associated state tables
                  Action:
                    - "dynamodb:*"
                  Resource:
                    - "Fn::Join":
                      - ""
                      - ["arn:aws:dynamodb:", {"Ref": "AWS::Region"},":",
                         {"Ref": "AWS::AccountId"}, ":", "table/", {"Ref": "StateTable"}]
                 {% endif %}

    Resource:
      Type: "AWS::ApiGateway::Resource"
      Properties:
        RestApiId:
          {% if api_id %}
          "{{api_id}}"
          {% else %}
          {"Ref": "RestApi"}
          {% endif %}
        ParentId:
            {% if api_id %}
            {{parent_resource_id}}
            {% else %}
            "Fn::GetAtt":
              - RestApi
              - RootResourceId
            {% endif %}
        PathPart: "{{resource_path}}"

    Method:
      Type: "AWS::ApiGateway::Method"
      Properties:
        RestApiId:
          {% if api_id %}
          {{api_id}}
          {% else %}
          {"Ref": "RestApi"}
          {% endif %}
        ResourceId: {Ref: "Resource"}
        HttpMethod: POST
        AuthorizationType: NONE
        Integration:
          Type: AWS
          IntegrationHttpMethod: POST
          Uri: {"Fn::Join" : ["", ["arn:aws:apigateway:", {"Ref": "AWS::Region"}, ":lambda:path/2015-03-31/functions/", {"Fn::GetAtt": ["Lambda", "Arn"]}, "/invocations"]]}
          PassthroughBehavior: WHEN_NO_TEMPLATES

    RestApiDeployment:
      Type: "AWS::ApiGateway::Deployment"
      DependsOn: ["Method"]
      Properties:
          RestApiId:
            {% if api_id %}
            {{api_id}}
            {% else %}
            {"Ref": "RestApi"}
            {% endif %}
          StageName: {{api_stage or _env.stage}}
